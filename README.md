# 線上視力測試應用程式 - 程式流程說明文檔

## 應用概述

這是一個由香港科技大學和醫院合作開發的眼睛測試應用程式，旨在提供基本的視力篩查測試，包括標準視力測試(LogMAR測試)、黃斑部退化測試以及色盲測試。

## 主要流程

此應用程式的流程如下：

1. **歡迎頁面 (`WelcomeView`)**
   - 顯示應用程式標題與簡介
   - 讓使用者輸入姓名（如未輸入則設置為 "no user name"）
   - 選擇語言（英文/繁體中文）
   - 點擊「開始」進入使用條款頁面

2. **使用條款頁面 (`TermsOfAgreementView`)**
   - 首次使用時顯示
   - 展示使用條款
   - 用戶同意條款後才能繼續

3. **權限請求頁面 (`PermissionRequestView`)**
   - 請求視力測試所需的權限（語音識別、相機）
   - 只有獲得所有權限後才能進行測試

4. **測試流程頁面 (`TestFlowView`)**
   - 按順序進行三個測試，不需要用戶手動選擇測試

5. **測試結果頁面 (`TestResultsView`)**
   - 顯示所有測試的綜合結果
   - 提供建議和重新測試的選項

## 頁面詳情

### 1. `WelcomeView`
- **用途**：應用程式的入口頁面
- **關鍵功能**：
  - 收集用戶姓名（如果為空則設為"no user name"）
  - 語言選擇（英文/繁體中文）
  - 引導進入使用條款頁面
- **關鍵狀態**：
  - `@AppStorage("hasCompletedOnboarding")` - 追蹤是否完成入門流程
  - `@AppStorage("username")` - 儲存用戶姓名
  - `@AppStorage("TermsAccepted")` - 跟蹤條款接受狀態

### 2. `TermsOfAgreementView`
- **用途**：展示使用條款和收集用戶同意
- **關鍵功能**：
  - 顯示使用條款文本
  - 提供「我同意」按鈕
- **狀態交互**：
  - 當用戶同意條款時，設置 `UserDefaults.standard` 中的 "TermsAccepted" 為 true
  - 同時設置 `isAccepted` 綁定為 true，通知父視圖

### 3. `PermissionRequestView`
- **用途**：獲取應用所需的權限
- **關鍵功能**：
  - 顯示需要的權限（語音識別、相機）
  - 提供請求權限的按鈕
- **使用時機**：在完成歡迎頁面和接受條款後，但在開始測試前顯示

### 4. 視力測試頁面

#### 4.1 `LogMARTestView`
- **用途**：標準視力測試
- **關鍵功能**：
  - 分別測試左眼和右眼視力
  - 顯示不同大小的字母
  - 監控測試距離
  - 支持語音輸入或手動輸入所見字母
- **何時使用**：測試流程的第一步
- **關鍵組件**：
  - `VisionTestManager` - 管理測試流程和結果
  - `FaceDistanceManager` - 監控用戶與設備的距離

#### 4.2 `MacularDegenerationTestView`
- **用途**：黃斑部退化篩查測試
- **關鍵功能**：
  - 顯示 Amsler 網格
  - 詢問用戶網格線條的外觀
  - 根據選擇提供評估結果
- **何時使用**：視力測試完成後，作為測試流程的第二步
- **關鍵組件**：
  - 網格圖像 (`amsler_grid`)
  - 選項按鈕組

#### 4.3 `ColorBlindnessTestView`
- **用途**：色盲/色弱測試
- **關鍵功能**：
  - 顯示石原色盲測試圖
  - 用戶識別圖中的數字
  - 根據答案計算分數和結果
- **何時使用**：黃斑部測試完成後，作為測試流程的第三步
- **關鍵組件**：
  - 色盲測試圖像 (`colorblind_test_1`, `colorblind_test_2`, `colorblind_test_3`)
  - 選項按鈕組

### 5. `TestResultsView`
- **用途**：顯示所有測試的結果
- **關鍵功能**：
  - 顯示用戶視力測試結果（LogMAR值等）
  - 顯示黃斑部測試和色盲測試的完成狀態
  - 提供重新測試的選項
- **何時使用**：所有三個測試完成後
- **關鍵組件**：
  - `VisionTestResultView` - 顯示詳細的視力測試結果

## 數據流

1. 用戶信息透過 `@AppStorage` 儲存，在不同視圖間共享
2. 視力測試結果由 `VisionTestManager.shared` 單例管理
3. 各測試完成後透過 `onComplete` 回調通知 `TestFlowView` 進入下一個測試
4. 最終所有測試結果在 `TestResultsView` 中展示

## 重要技術和設計模式

1. **SwiftUI** 用於所有用戶界面
2. **MVVM架構** - 視圖由視圖模型（如 `VisionTestManager`）驅動
3. **觀察者模式** - 使用 `ObservableObject` 和 `@Published` 建立數據綁定
4. **依賴注入** - 使用 `@Binding` 和 `@StateObject` 進行狀態共享
5. **單例模式** - 使用 `VisionTestManager.shared` 在不同視圖間共享測試結果

## 注意事項

1. 所有界面使用淺色模式（白色背景）
2. 視力測試需要保持適當的測試距離（55-60厘米）
3. 色盲測試和黃斑部測試需要相應的圖像資源在 `Assets.xcassets` 中存在
4. 應用程式的所有頁面按順序引導用戶，無需手動導航 